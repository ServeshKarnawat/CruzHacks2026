<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Flex vs Time</title>
    <style>
      body {
        margin: 0;
        padding: 2rem;
        font-family: Arial, sans-serif;
        background: #f7f4ee;
        color: #2d2a24;
      }
      h1 {
        margin: 0 0 1rem;
        font-size: 1.6rem;
      }
      canvas {
        width: 100%;
        max-width: 900px;
        height: 380px;
        border: 1px solid #d9d1c5;
        background: #fffdf8;
      }
    </style>
  </head>
  <body>
    <h1>Flex vs Time</h1>
    <canvas id="chart" width="900" height="380"></canvas>

    <script>
      const canvas = document.getElementById("chart");
      const ctx = canvas.getContext("2d");

      const padding = { left: 60, right: 20, top: 20, bottom: 50 };

      function toNumber(value) {
        const num = Number(value);
        return Number.isFinite(num) ? num : 0;
      }

      function parseTime(value) {
        const parts = String(value).split(":").map(Number);
        if (parts.length !== 3 || parts.some(n => !Number.isFinite(n))) {
          return NaN;
        }
        return parts[0] * 3600 + parts[1] * 60 + parts[2];
      }

      function formatTime(seconds) {
        const s = Math.max(0, Math.round(seconds));
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}:${String(sec).padStart(2, "0")}`;
      }

      function drawAxes(width, height, maxX, maxY) {
        ctx.strokeStyle = "#5b554a";
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(padding.left, padding.top);
        ctx.lineTo(padding.left, height - padding.bottom);
        ctx.lineTo(width - padding.right, height - padding.bottom);
        ctx.stroke();

        ctx.fillStyle = "#5b554a";
        ctx.font = "14px Arial, sans-serif";
        ctx.textAlign = "center";
        ctx.fillText("time", padding.left + (width - padding.left - padding.right) / 2, height - 15);

        ctx.save();
        ctx.translate(18, padding.top + (height - padding.top - padding.bottom) / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText("flex", 0, 0);
        ctx.restore();

        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        ctx.fillStyle = "#6a6258";
        ctx.font = "12px Arial, sans-serif";

        const ticks = 5;
        ctx.textAlign = "center";
        for (let i = 0; i <= ticks; i++) {
          const x = padding.left + (chartWidth * i) / ticks;
          const value = (maxX * i) / ticks;
          ctx.fillText(formatTime(value), x, height - 25);
        }

        ctx.textAlign = "right";
        for (let i = 0; i <= ticks; i++) {
          const y = padding.top + chartHeight - (chartHeight * i) / ticks;
          const value = (maxY * i) / ticks;
          ctx.fillText(value.toFixed(1), padding.left - 8, y + 4);
        }
      }

      function drawLine(times, values, maxX, maxY) {
        const width = canvas.width;
        const height = canvas.height;
        const chartWidth = width - padding.left - padding.right;
        const chartHeight = height - padding.top - padding.bottom;

        ctx.strokeStyle = "#d26a4f";
        ctx.lineWidth = 2;
        ctx.beginPath();

        values.forEach((value, index) => {
          const x = padding.left + (times[index] / maxX) * chartWidth;
          const y = padding.top + chartHeight - (value / maxY) * chartHeight;
          if (index === 0) {
            ctx.moveTo(x, y); 
          } else {
            ctx.lineTo(x, y);
          }
        });

        ctx.stroke();
      }

      async function render() {
        const res = await fetch("/data"); //fetch data from csv
        const data = await res.json(); 

        if (!Array.isArray(data) || data.length === 0) {
          ctx.fillText("No data to plot.", 100, 100);
          return;
        }

        const rawTimes = data.map(row => parseTime(row.time));
        const baseTime = rawTimes.find(t => Number.isFinite(t));
        if (!Number.isFinite(baseTime)) {
          ctx.fillText("Invalid timestamps.", 100, 100);
          return;
        }

        const times = rawTimes.map(t => Math.max(0, t - baseTime));
        const flexValues = data.map(row => toNumber(row.flex));
        const maxX = Math.max(1, ...times);
        const maxY = Math.max(1, ...flexValues);

        ctx.clearRect(0, 0, canvas.width, canvas.height); //wipe chart
        drawAxes(canvas.width, canvas.height, maxX, maxY);
        drawLine(times, flexValues, maxX, maxY);
      }

      render();
    </script>
  </body>
</html>
